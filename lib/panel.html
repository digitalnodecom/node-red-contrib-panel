<!-- Panel Button Script -->
<script type="text/javascript">
    // Add Panel button to Node-RED header
    (function() {
        function addPanelButton() {
            // Check if button already exists
            if (document.getElementById('red-ui-header-button-panel')) {
                return;
            }
            
            // Look for the menu button (hamburger icon) - try multiple possible selectors
            const menuButton = document.getElementById('red-ui-header-button-sidemenu') || 
                              document.querySelector('#red-ui-header .fa-bars')?.parentElement ||
                              document.querySelector('[data-toggle="dropdown"]');
                              
            const deployButton = document.getElementById('red-ui-header-button-deploy');
            
            // Prefer positioning relative to menu button, fall back to deploy button
            const targetButton = menuButton || deployButton;
            
            if (targetButton && targetButton.parentElement) {
                // Create the panel button
                const panelButton = document.createElement('a');
                panelButton.id = 'red-ui-header-button-panel';
                panelButton.className = 'button';
                panelButton.href = '/panel';
                panelButton.target = '_blank';
                panelButton.title = 'Open Panel';
                panelButton.style.paddingTop = '0';
                panelButton.style.paddingBottom = '0';
                panelButton.style.width = '30px';
                panelButton.style.height = '30px';
                panelButton.style.display = 'inline-flex';
                panelButton.style.alignItems = 'center';
                panelButton.style.justifyContent = 'center';
                panelButton.style.marginRight = '5px';
                panelButton.innerHTML = '<svg width="30" height="30" viewBox="0 0 448 448" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M392 0H56C25.0721 0 0 25.0721 0 56V392C0 422.928 25.0721 448 56 448H392C422.928 448 448 422.928 448 392V56C448 25.0721 422.928 0 392 0Z" fill="#8F0000"/><path d="M224 90.1875C156.292 90.1875 103.25 121.13 103.25 160.625V281.375C103.25 320.87 156.292 351.812 224 351.812C291.708 351.812 344.75 320.87 344.75 281.375V160.625C344.75 121.13 291.708 90.1875 224 90.1875ZM324.625 221C324.625 233.1 314.713 245.439 297.444 254.86C277.998 265.464 251.911 271.312 224 271.312C196.089 271.312 170.002 265.464 150.556 254.86C133.287 245.439 123.375 233.1 123.375 221V200.07C144.833 218.937 181.524 231.062 224 231.062C266.476 231.062 303.167 218.887 324.625 200.07V221ZM150.556 126.765C170.002 116.161 196.089 110.312 224 110.312C251.911 110.312 277.998 116.161 297.444 126.765C314.713 136.186 324.625 148.525 324.625 160.625C324.625 172.725 314.713 185.064 297.444 194.485C277.998 205.089 251.911 210.938 224 210.938C196.089 210.938 170.002 205.089 150.556 194.485C133.287 185.064 123.375 172.725 123.375 160.625C123.375 148.525 133.287 136.186 150.556 126.765ZM297.444 315.235C277.998 325.839 251.911 331.688 224 331.688C196.089 331.688 170.002 325.839 150.556 315.235C133.287 305.814 123.375 293.475 123.375 281.375V260.445C144.833 279.312 181.524 291.438 224 291.438C266.476 291.438 303.167 279.262 324.625 260.445V281.375C324.625 293.475 314.713 305.814 297.444 315.235Z" fill="white"/></svg>';
                
                // Insert before the target button (menu or deploy)
                targetButton.parentElement.insertBefore(panelButton, targetButton);
            } else {
                // If deploy button not found yet, try again
                setTimeout(addPanelButton, 500);
            }
        }
        
        // Try to add button when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', addPanelButton);
        } else {
            // DOM already loaded
            setTimeout(addPanelButton, 100);
        }
    })();
</script>

<!-- Panel Query Node -->
<script type="text/javascript">
    RED.nodes.registerType('query', {
        category: 'Panel',
        color: '#ffcccb',
        defaults: {
            name: { value: "" },
            database: { value: "master", required: false },
            collection: { value: "", required: false },
            operation: { value: "find", required: false },
            query: { value: "{}" },
            useMsg: { value: false }
        },
        inputs: 1,
        outputs: 1,
        icon: "node-red-panel.svg",
        label: function() {
            return this.name || "query";
        },
        oneditprepare: function() {
            const node = this;
            
            // Initialize typed input for query
            $("#node-input-query").typedInput({
                type: "json",
                types: ["json"]
            });
            
            // Panel internal token for authentication
            let panelInternalToken = null;
            
            // Load internal token
            function loadInternalToken() {
                return $.getJSON('/panel/internal-token')
                    .done(function(response) {
                        panelInternalToken = response.token;
                    })
                    .fail(function() {
                        console.warn('Could not load panel internal token');
                    });
            }
            
            // Load databases for dropdown
            function loadDatabases() {
                const headers = panelInternalToken ? { 'X-Internal-Token': panelInternalToken } : {};
                $.ajax({
                    url: '/panel/node-databases',
                    type: 'GET',
                    headers: headers
                })
                    .done(function(databases) {
                        const select = $("#node-input-database");
                        select.empty();
                        databases.forEach(function(db) {
                            const selected = db.id === node.database ? 'selected' : '';
                            select.append(`<option value="${db.id}" ${selected}>${db.name}</option>`);
                        });
                        if (node.database) {
                            select.val(node.database);
                        }
                        // Load collections after database is set
                        loadCollections();
                    })
                    .fail(function() {
                        console.warn('Could not load databases for dropdown');
                    });
            }
            
            // Load collections for dropdown based on selected database
            function loadCollections() {
                const database = $("#node-input-database").val() || 'master';
                const headers = panelInternalToken ? { 'X-Internal-Token': panelInternalToken } : {};
                $.ajax({
                    url: `/panel/node-collections?database=${database}`,
                    type: 'GET',
                    headers: headers
                })
                    .done(function(collections) {
                        const select = $("#node-input-collection");
                        select.empty();
                        select.append('<option value="">Select collection...</option>');
                        collections.forEach(function(collection) {
                            select.append(`<option value="${collection}">${collection}</option>`);
                        });
                        if (node.collection) {
                            select.val(node.collection);
                        }
                    })
                    .fail(function() {
                        console.warn('Could not load collections for dropdown');
                    });
            }
            
            // Handle database selection change
            $("#node-input-database").change(function() {
                loadCollections();
            });
            
            // Load internal token first, then databases and collections
            loadInternalToken().always(function() {
                loadDatabases();
            });
            
            // Handle useMsg checkbox changes
            function toggleMsgOptions() {
                const useMsg = $("#node-input-useMsg").prop('checked');
                if (useMsg) {
                    $("#static-config").hide();
                    $("#msg-config").show();
                } else {
                    $("#static-config").show();
                    $("#msg-config").hide();
                }
            }
            
            $("#node-input-useMsg").change(toggleMsgOptions);
            toggleMsgOptions(); // Initial state
        }
    });
</script>

<script type="text/html" data-template-name="query">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    
    <div class="form-row">
        <label for="node-input-useMsg"><i class="fa fa-exchange"></i> Use msg properties</label>
        <input type="checkbox" id="node-input-useMsg" style="display:inline-block; width:20px; vertical-align:baseline;">
        <span style="margin-left:10px;">Override configuration with msg.collection, msg.operation, msg.query</span>
    </div>
    
    <div id="static-config">
        <div class="form-row">
            <label for="node-input-database"><i class="fa fa-server"></i> Database</label>
            <select id="node-input-database" style="width:70%;">
                <option value="master">Loading databases...</option>
            </select>
            <div style="font-size: 11px; color: #666; margin-top: 4px;">
                <i class="fa fa-info-circle"></i> Optional: Defaults to master. Use <code>msg.database</code> to override.
            </div>
        </div>
        <div class="form-row">
            <label for="node-input-collection"><i class="fa fa-database"></i> Collection</label>
            <select id="node-input-collection" style="width:70%;">
                <option value="">Loading collections...</option>
            </select>
            <div style="font-size: 11px; color: #666; margin-top: 4px;">
                <i class="fa fa-info-circle"></i> Required unless provided via <code>msg.collection</code>.
            </div>
        </div>
        <div class="form-row">
            <label for="node-input-operation"><i class="fa fa-cog"></i> Operation</label>
            <select id="node-input-operation">
                <option value="find">Find All</option>
                <option value="findOne">Find One</option>
                <option value="count">Count</option>
            </select>
            <div style="font-size: 11px; color: #666; margin-top: 4px;">
                <i class="fa fa-info-circle"></i> Operation type. Use <code>msg.operation</code> to override (find, findOne, count).
            </div>
        </div>
        <div class="form-row">
            <label for="node-input-query"><i class="fa fa-filter"></i> Query</label>
            <input type="text" id="node-input-query" placeholder='{"id": 1}'>
            <div style="font-size: 11px; color: #666; margin-top: 4px;">
                <i class="fa fa-info-circle"></i> Query parameters as JSON. Use <code>msg.query</code> to override.
            </div>
        </div>
    </div>
    
    <div id="msg-config" style="display:none;">
        <div class="form-row">
            <p style="margin:10px 0; padding:10px; background:#f0f0f0; border-radius:3px;">
                <i class="fa fa-info-circle"></i> When using msg properties:
                <br>• <code>msg.database</code> - Database name (optional, defaults to configured)
                <br>• <code>msg.collection</code> - Collection name
                <br>• <code>msg.operation</code> - Operation type (find, findOne, count)
                <br>• <code>msg.query</code> - Query parameters object
            </p>
        </div>
    </div>
</script>

<script type="text/html" data-help-name="query">
    <p>Query data from a Panel collection.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>query <span class="property-type">object</span></dt>
        <dd>Optional query parameters to override node configuration</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object | array</span></dt>
        <dd>The query results</dd>
    </dl>
</script>

<!-- Panel Insert Node -->
<script type="text/javascript">
    RED.nodes.registerType('insert', {
        category: 'Panel',
        color: '#ffcccb',
        defaults: {
            name: { value: "" },
            database: { value: "master", required: false },
            collection: { value: "", required: false },
            useMsg: { value: false },
            data: { value: "{\"title\": \"Sample Article\", \"content\": \"Lorem ipsum...\", \"published\": true}" }
        },
        inputs: 1,
        outputs: 1,
        icon: "node-red-panel.svg",
        label: function() {
            return this.name || "insert";
        },
        oneditprepare: function() {
            const node = this;
            
            // Panel internal token for authentication
            let panelInternalToken = null;
            
            // Load internal token
            function loadInternalToken() {
                return $.getJSON('/panel/internal-token')
                    .done(function(response) {
                        panelInternalToken = response.token;
                    })
                    .fail(function() {
                        console.warn('Could not load panel internal token');
                    });
            }
            
            // Load databases for dropdown
            function loadDatabases() {
                const headers = panelInternalToken ? { 'X-Internal-Token': panelInternalToken } : {};
                $.ajax({
                    url: '/panel/node-databases',
                    type: 'GET',
                    headers: headers
                })
                    .done(function(databases) {
                        const select = $("#node-input-database");
                        select.empty();
                        databases.forEach(function(db) {
                            const selected = db.id === node.database ? 'selected' : '';
                            select.append(`<option value="${db.id}" ${selected}>${db.name}</option>`);
                        });
                        if (node.database) {
                            select.val(node.database);
                        }
                        // Load collections after database is set
                        loadCollections();
                    })
                    .fail(function() {
                        console.warn('Could not load databases for dropdown');
                    });
            }
            
            // Load collections for dropdown based on selected database
            function loadCollections() {
                const database = $("#node-input-database").val() || 'master';
                const headers = panelInternalToken ? { 'X-Internal-Token': panelInternalToken } : {};
                $.ajax({
                    url: `/panel/node-collections?database=${database}`,
                    type: 'GET',
                    headers: headers
                })
                    .done(function(collections) {
                        const select = $("#node-input-collection");
                        select.empty();
                        select.append('<option value="">Select collection...</option>');
                        collections.forEach(function(collection) {
                            select.append(`<option value="${collection}">${collection}</option>`);
                        });
                        if (node.collection) {
                            select.val(node.collection);
                        }
                    })
                    .fail(function() {
                        console.warn('Could not load collections for dropdown');
                    });
            }
            
            // Handle database selection change
            $("#node-input-database").change(function() {
                loadCollections();
            });
            
            // Load internal token first, then databases and collections
            loadInternalToken().always(function() {
                loadDatabases();
            });
            
            // Initialize typed input for data (insert node)
            if ($("#node-input-data").length) {
                $("#node-input-data").typedInput({
                    type: "json",
                    types: ["json"]
                });
            }
            
            // Handle useMsg checkbox changes
            function toggleMsgOptions() {
                const useMsg = $("#node-input-useMsg").prop('checked');
                if (useMsg) {
                    $("#static-config").hide();
                    $("#msg-config").show();
                } else {
                    $("#static-config").show();
                    $("#msg-config").hide();
                }
            }
            
            $("#node-input-useMsg").change(toggleMsgOptions);
            toggleMsgOptions(); // Initial state
        }
    });
</script>

<script type="text/html" data-template-name="insert">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    
    <div class="form-row">
        <label for="node-input-useMsg"><i class="fa fa-exchange"></i> Use msg properties</label>
        <input type="checkbox" id="node-input-useMsg" style="display:inline-block; width:20px; vertical-align:baseline;">
        <span style="margin-left:10px;">Override configuration with msg.collection</span>
    </div>
    
    <div id="static-config">
        <div class="form-row">
            <label for="node-input-database"><i class="fa fa-server"></i> Database</label>
            <select id="node-input-database" style="width:70%;">
                <option value="master">Loading databases...</option>
            </select>
            <div style="font-size: 11px; color: #666; margin-top: 4px;">
                <i class="fa fa-info-circle"></i> Optional: Defaults to master. Use <code>msg.database</code> to override.
            </div>
        </div>
        <div class="form-row">
            <label for="node-input-collection"><i class="fa fa-database"></i> Collection</label>
            <select id="node-input-collection" style="width:70%;">
                <option value="">Loading collections...</option>
            </select>
            <div style="font-size: 11px; color: #666; margin-top: 4px;">
                <i class="fa fa-info-circle"></i> Required unless provided via <code>msg.collection</code>.
            </div>
        </div>
        <div class="form-row">
            <label for="node-input-data"><i class="fa fa-edit"></i> Data (optional)</label>
            <input type="text" id="node-input-data" placeholder='{"title": "Sample Article", "content": "Lorem ipsum...", "published": true}'>
            <div style="font-size: 11px; color: #666; margin-top: 4px;">
                <i class="fa fa-info-circle"></i> Optional: Static JSON data for testing. <code>msg.payload</code> takes precedence.
            </div>
        </div>
    </div>
    
    <div id="msg-config" style="display:none;">
        <div class="form-row">
            <p style="margin:10px 0; padding:10px; background:#f0f0f0; border-radius:3px;">
                <i class="fa fa-info-circle"></i> When using msg properties:
                <br>• <code>msg.database</code> - Database name (optional, defaults to configured)
                <br>• <code>msg.collection</code> - Collection name
                <br>• <code>msg.payload</code> - Data to insert
                <br>• If no msg.payload, uses configured static data
            </p>
        </div>
    </div>
</script>

<script type="text/html" data-help-name="insert">
    <p>Insert a new record into a Panel collection.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object</span></dt>
        <dd>The data to insert</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload.id <span class="property-type">number</span></dt>
        <dd>The ID of the inserted record</dd>
        <dt>payload.changes <span class="property-type">number</span></dt>
        <dd>Number of rows affected</dd>
    </dl>
</script>

<!-- Panel Update Node -->
<script type="text/javascript">
    RED.nodes.registerType('update', {
        category: 'Panel',
        color: '#ffcccb',
        defaults: {
            name: { value: "" },
            database: { value: "master", required: false },
            collection: { value: "", required: false },
            useMsg: { value: false },
            data: { value: "{\"id\": 1, \"title\": \"Updated Title\", \"published\": false}" }
        },
        inputs: 1,
        outputs: 1,
        icon: "node-red-panel.svg",
        label: function() {
            return this.name || "update";
        },
        oneditprepare: function() {
            const node = this;
            
            // Panel internal token for authentication
            let panelInternalToken = null;
            
            // Load internal token
            function loadInternalToken() {
                return $.getJSON('/panel/internal-token')
                    .done(function(response) {
                        panelInternalToken = response.token;
                    })
                    .fail(function() {
                        console.warn('Could not load panel internal token');
                    });
            }
            
            // Load databases for dropdown
            function loadDatabases() {
                const headers = panelInternalToken ? { 'X-Internal-Token': panelInternalToken } : {};
                $.ajax({
                    url: '/panel/node-databases',
                    type: 'GET',
                    headers: headers
                })
                    .done(function(databases) {
                        const select = $("#node-input-database");
                        select.empty();
                        databases.forEach(function(db) {
                            const selected = db.id === node.database ? 'selected' : '';
                            select.append(`<option value="${db.id}" ${selected}>${db.name}</option>`);
                        });
                        if (node.database) {
                            select.val(node.database);
                        }
                        // Load collections after database is set
                        loadCollections();
                    })
                    .fail(function() {
                        console.warn('Could not load databases for dropdown');
                    });
            }
            
            // Load collections for dropdown based on selected database
            function loadCollections() {
                const database = $("#node-input-database").val() || 'master';
                const headers = panelInternalToken ? { 'X-Internal-Token': panelInternalToken } : {};
                $.ajax({
                    url: `/panel/node-collections?database=${database}`,
                    type: 'GET',
                    headers: headers
                })
                    .done(function(collections) {
                        const select = $("#node-input-collection");
                        select.empty();
                        select.append('<option value="">Select collection...</option>');
                        collections.forEach(function(collection) {
                            select.append(`<option value="${collection}">${collection}</option>`);
                        });
                        if (node.collection) {
                            select.val(node.collection);
                        }
                    })
                    .fail(function() {
                        console.warn('Could not load collections for dropdown');
                    });
            }
            
            // Handle database selection change
            $("#node-input-database").change(function() {
                loadCollections();
            });
            
            // Load internal token first, then databases and collections
            loadInternalToken().always(function() {
                loadDatabases();
            });
            
            // Initialize typed input for data (update node)
            if ($("#node-input-data").length) {
                $("#node-input-data").typedInput({
                    type: "json",
                    types: ["json"]
                });
            }
            
            // Handle useMsg checkbox changes
            function toggleMsgOptions() {
                const useMsg = $("#node-input-useMsg").prop('checked');
                if (useMsg) {
                    $("#static-config").hide();
                    $("#msg-config").show();
                } else {
                    $("#static-config").show();
                    $("#msg-config").hide();
                }
            }
            
            $("#node-input-useMsg").change(toggleMsgOptions);
            toggleMsgOptions(); // Initial state
        }
    });
</script>

<script type="text/html" data-template-name="update">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    
    <div class="form-row">
        <label for="node-input-useMsg"><i class="fa fa-exchange"></i> Use msg properties</label>
        <input type="checkbox" id="node-input-useMsg" style="display:inline-block; width:20px; vertical-align:baseline;">
        <span style="margin-left:10px;">Override configuration with msg.collection</span>
    </div>
    
    <div id="static-config">
        <div class="form-row">
            <label for="node-input-database"><i class="fa fa-server"></i> Database</label>
            <select id="node-input-database" style="width:70%;">
                <option value="master">Loading databases...</option>
            </select>
            <div style="font-size: 11px; color: #666; margin-top: 4px;">
                <i class="fa fa-info-circle"></i> Optional: Defaults to master. Use <code>msg.database</code> to override.
            </div>
        </div>
        <div class="form-row">
            <label for="node-input-collection"><i class="fa fa-database"></i> Collection</label>
            <select id="node-input-collection" style="width:70%;">
                <option value="">Loading collections...</option>
            </select>
            <div style="font-size: 11px; color: #666; margin-top: 4px;">
                <i class="fa fa-info-circle"></i> Required unless provided via <code>msg.collection</code>.
            </div>
        </div>
        <div class="form-row">
            <label for="node-input-data"><i class="fa fa-edit"></i> Data (optional)</label>
            <input type="text" id="node-input-data" placeholder='{"id": 1, "title": "Updated Title", "published": false}'>
            <div style="font-size: 11px; color: #666; margin-top: 4px;">
                <i class="fa fa-info-circle"></i> Optional: Static JSON with id and fields. <code>msg.payload</code> takes precedence.
            </div>
        </div>
    </div>
    
    <div id="msg-config" style="display:none;">
        <div class="form-row">
            <p style="margin:10px 0; padding:10px; background:#f0f0f0; border-radius:3px;">
                <i class="fa fa-info-circle"></i> When using msg properties:
                <br>• <code>msg.database</code> - Database name (optional, defaults to configured)
                <br>• <code>msg.collection</code> - Collection name
                <br>• <code>msg.payload</code> - Object with id and fields to update
                <br>• If no msg.payload, uses configured static data
            </p>
        </div>
    </div>
</script>

<script type="text/html" data-help-name="update">
    <p>Update a record in a Panel collection.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object</span></dt>
        <dd>Object containing id and fields to update</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload.id <span class="property-type">number</span></dt>
        <dd>The ID of the updated record</dd>
        <dt>payload.changes <span class="property-type">number</span></dt>
        <dd>Number of rows affected</dd>
    </dl>
</script>

<!-- Panel Delete Node -->
<script type="text/javascript">
    RED.nodes.registerType('delete', {
        category: 'Panel',
        color: '#ffcccb',
        defaults: {
            name: { value: "" },
            database: { value: "master", required: false },
            collection: { value: "", required: false },
            useMsg: { value: false },
            data: { value: "5" }
        },
        inputs: 1,
        outputs: 1,
        icon: "node-red-panel.svg",
        label: function() {
            return this.name || "delete";
        },
        oneditprepare: function() {
            const node = this;
            
            // Panel internal token for authentication
            let panelInternalToken = null;
            
            // Load internal token
            function loadInternalToken() {
                return $.getJSON('/panel/internal-token')
                    .done(function(response) {
                        panelInternalToken = response.token;
                    })
                    .fail(function() {
                        console.warn('Could not load panel internal token');
                    });
            }
            
            // Load databases for dropdown
            function loadDatabases() {
                const headers = panelInternalToken ? { 'X-Internal-Token': panelInternalToken } : {};
                $.ajax({
                    url: '/panel/node-databases',
                    type: 'GET',
                    headers: headers
                })
                    .done(function(databases) {
                        const select = $("#node-input-database");
                        select.empty();
                        databases.forEach(function(db) {
                            const selected = db.id === node.database ? 'selected' : '';
                            select.append(`<option value="${db.id}" ${selected}>${db.name}</option>`);
                        });
                        if (node.database) {
                            select.val(node.database);
                        }
                        // Load collections after database is set
                        loadCollections();
                    })
                    .fail(function() {
                        console.warn('Could not load databases for dropdown');
                    });
            }
            
            // Load collections for dropdown based on selected database
            function loadCollections() {
                const database = $("#node-input-database").val() || 'master';
                const headers = panelInternalToken ? { 'X-Internal-Token': panelInternalToken } : {};
                $.ajax({
                    url: `/panel/node-collections?database=${database}`,
                    type: 'GET',
                    headers: headers
                })
                    .done(function(collections) {
                        const select = $("#node-input-collection");
                        select.empty();
                        select.append('<option value="">Select collection...</option>');
                        collections.forEach(function(collection) {
                            select.append(`<option value="${collection}">${collection}</option>`);
                        });
                        if (node.collection) {
                            select.val(node.collection);
                        }
                    })
                    .fail(function() {
                        console.warn('Could not load collections for dropdown');
                    });
            }
            
            // Handle database selection change
            $("#node-input-database").change(function() {
                loadCollections();
            });
            
            // Load internal token first, then databases and collections
            loadInternalToken().always(function() {
                loadDatabases();
            });
            
            // Handle useMsg checkbox changes
            function toggleMsgOptions() {
                const useMsg = $("#node-input-useMsg").prop('checked');
                if (useMsg) {
                    $("#static-config").hide();
                    $("#msg-config").show();
                } else {
                    $("#static-config").show();
                    $("#msg-config").hide();
                }
            }
            
            $("#node-input-useMsg").change(toggleMsgOptions);
            toggleMsgOptions(); // Initial state
        }
    });
</script>

<script type="text/html" data-template-name="delete">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    
    <div class="form-row">
        <label for="node-input-useMsg"><i class="fa fa-exchange"></i> Use msg properties</label>
        <input type="checkbox" id="node-input-useMsg" style="display:inline-block; width:20px; vertical-align:baseline;">
        <span style="margin-left:10px;">Override configuration with msg.collection</span>
    </div>
    
    <div id="static-config">
        <div class="form-row">
            <label for="node-input-database"><i class="fa fa-server"></i> Database</label>
            <select id="node-input-database" style="width:70%;">
                <option value="master">Loading databases...</option>
            </select>
            <div style="font-size: 11px; color: #666; margin-top: 4px;">
                <i class="fa fa-info-circle"></i> Optional: Defaults to master. Use <code>msg.database</code> to override.
            </div>
        </div>
        <div class="form-row">
            <label for="node-input-collection"><i class="fa fa-database"></i> Collection</label>
            <select id="node-input-collection" style="width:70%;">
                <option value="">Loading collections...</option>
            </select>
            <div style="font-size: 11px; color: #666; margin-top: 4px;">
                <i class="fa fa-info-circle"></i> Required unless provided via <code>msg.collection</code>.
            </div>
        </div>
        <div class="form-row">
            <label for="node-input-data"><i class="fa fa-key"></i> Record ID (optional)</label>
            <input type="text" id="node-input-data" placeholder="5">
            <div style="font-size: 11px; color: #666; margin-top: 4px;">
                <i class="fa fa-info-circle"></i> Optional: Static record ID for testing. <code>msg.payload</code> takes precedence.
            </div>
        </div>
    </div>
    
    <div id="msg-config" style="display:none;">
        <div class="form-row">
            <p style="margin:10px 0; padding:10px; background:#f0f0f0; border-radius:3px;">
                <i class="fa fa-info-circle"></i> When using msg properties:
                <br>• <code>msg.database</code> - Database name (optional, defaults to configured)
                <br>• <code>msg.collection</code> - Collection name
                <br>• <code>msg.payload</code> - Record ID or object with id property
                <br>• If no msg.payload, uses configured static record ID
            </p>
        </div>
    </div>
</script>

<script type="text/html" data-help-name="delete">
    <p>Delete a record from a Panel collection.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">number | object</span></dt>
        <dd>The record ID or object with id property</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload.id <span class="property-type">number</span></dt>
        <dd>The ID of the deleted record</dd>
        <dt>payload.changes <span class="property-type">number</span></dt>
        <dd>Number of rows affected</dd>
    </dl>
</script>

<!-- Panel Upsert Node -->
<script type="text/javascript">
    RED.nodes.registerType('upsert', {
        category: 'Panel',
        color: '#ffcccb',
        defaults: {
            name: { value: "" },
            database: { value: "master", required: false },
            collection: { value: "", required: false },
            matchFields: { value: [] },
            mode: { value: "upsert" },
            useMsg: { value: false },
            data: { value: '{"email": "user@example.com", "name": "John Doe", "role": "admin"}' }
        },
        inputs: 1,
        outputs: 1,
        icon: "node-red-panel.svg",
        label: function() {
            return this.name || "upsert";
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            const node = this;
            
            // Handle database selection change
            $("#node-input-database").change(function() {
                loadCollections();
            });
            
            // Load internal token first, then databases and collections
            loadInternalToken().always(function() {
                loadDatabases();
            });
            
            // Collection change handler
            $('#node-input-collection').on('change', function() {
                const collection = $(this).val();
                if (collection) {
                    loadCollectionFields(collection);
                    $('#matchFields-section, #operation-mode-section').show();
                } else {
                    $('#matchFields-section, #operation-mode-section, #match-preview-section').hide();
                }
            });
            
            // Field selection change handler
            $(document).on('change', '#field-checkboxes input[type="checkbox"]', function() {
                updateMatchPreview();
                togglePreviewSection();
            });
            
            // Mode change handler
            $('input[name="node-input-mode"]').on('change', function() {
                updateMatchPreview();
            });
            
            // Panel internal token for authentication
            let panelInternalToken = null;
            
            // Load internal token
            function loadInternalToken() {
                return $.getJSON('/panel/internal-token')
                    .done(function(response) {
                        panelInternalToken = response.token;
                    })
                    .fail(function() {
                        console.warn('Could not load panel internal token');
                    });
            }
            
            // Load databases for dropdown
            function loadDatabases() {
                const headers = panelInternalToken ? { 'X-Internal-Token': panelInternalToken } : {};
                $.ajax({
                    url: '/panel/node-databases',
                    type: 'GET',
                    headers: headers
                })
                    .done(function(databases) {
                        const select = $("#node-input-database");
                        select.empty();
                        databases.forEach(function(db) {
                            const selected = db.id === node.database ? 'selected' : '';
                            select.append(`<option value="${db.id}" ${selected}>${db.name}</option>`);
                        });
                        if (node.database) {
                            select.val(node.database);
                        }
                        // Load collections after database is set
                        loadCollections();
                    })
                    .fail(function() {
                        console.warn('Could not load databases for dropdown');
                    });
            }
            
            function loadCollections() {
                const database = $("#node-input-database").val() || 'master';
                const headers = panelInternalToken ? { 'X-Internal-Token': panelInternalToken } : {};
                $.ajax({
                    url: `/panel/node-collections?database=${database}`,
                    type: 'GET',
                    headers: headers
                })
                    .done(function(collections) {
                        const select = $('#node-input-collection');
                        select.empty().append('<option value="">Select collection...</option>');
                        collections.forEach(function(collection) {
                            const selected = collection === node.collection ? 'selected' : '';
                            select.append(`<option value="${collection}" ${selected}>${collection}</option>`);
                        });
                        
                        // Trigger change if collection was pre-selected
                        if (node.collection) {
                            select.trigger('change');
                        }
                    })
                    .fail(function() {
                        console.error('Failed to load collections');
                    });
            }
            
            function loadCollectionFields(collection) {
                const database = $("#node-input-database").val() || 'master';
                $.getJSON(`/panel/node-collection-fields?collection=${collection}&database=${database}`)
                    .done(function(fields) {
                        const container = $('#field-checkboxes');
                        container.empty();
                        
                        fields.forEach(function(field) {
                            const uniqueIcon = field.unique ? ' <i class="fa fa-key" style="color: gold; margin-left: 4px;" title="Unique field"></i>' : '';
                            const indexIcon = field.indexable ? ' <i class="fa fa-flash" style="color: green; margin-left: 4px;" title="Indexed field"></i>' : '';
                            
                            const checked = node.matchFields && node.matchFields.includes(field.name) ? 'checked' : '';
                            
                            container.append(`
                                <label style="display: inline-block; padding: 4px 8px; margin-right: 10px; margin-bottom: 6px; cursor: pointer; white-space: nowrap;">
                                    <input type="checkbox" value="${field.name}" ${checked} style="margin-right: 6px;">
                                    <strong>${field.name}</strong> 
                                    <span style="color: #666; font-size: 11px;">(${field.type})</span>
                                    ${uniqueIcon}${indexIcon}
                                </label>
                            `);
                        });
                        
                        updateMatchPreview();
                        togglePreviewSection();
                    })
                    .fail(function() {
                        console.error('Failed to load collection fields');
                    });
            }
            
            function updateMatchPreview() {
                const selectedFields = $('#field-checkboxes input:checked').map(function() {
                    return $(this).val();
                }).get();
                
                const mode = $('input[name="node-input-mode"]:checked').val();
                const collection = $('#node-input-collection').val();
                
                if (selectedFields.length > 0 && collection) {
                    let preview = `INSERT INTO ${collection} (...) VALUES (...)\n`;
                    preview += `ON CONFLICT(${selectedFields.join(', ')}) `;
                    
                    switch(mode) {
                        case 'upsert':
                            preview += `DO UPDATE SET ...`;
                            break;
                        case 'updateOnly':
                            preview += `DO UPDATE SET ... (only if exists)`;
                            break;
                        case 'insertOnly':
                            preview += `DO NOTHING`;
                            break;
                    }
                    
                    $('#match-preview').text(preview);
                }
            }
            
            function togglePreviewSection() {
                const hasSelection = $('#field-checkboxes input:checked').length > 0;
                $('#match-preview-section').toggle(hasSelection);
            }
        },
        
        oneditsave: function() {
            // Save selected match fields
            const selectedFields = $('#field-checkboxes input:checked').map(function() {
                return $(this).val();
            }).get();
            this.matchFields = selectedFields;
            
            // Save selected mode
            this.mode = $('input[name="node-input-mode"]:checked').val();
        }
    });
</script>
<script type="text/html" data-template-name="upsert">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    
    <div class="form-row">
        <label for="node-input-useMsg"><i class="fa fa-exchange"></i> Use msg properties</label>
        <input type="checkbox" id="node-input-useMsg" style="display:inline-block; width:20px; vertical-align:baseline;">
        <span style="margin-left:10px;">Override configuration with msg.database, msg.collection, msg.matchFields, msg.mode</span>
    </div>
    
    <div class="form-row">
        <label for="node-input-database"><i class="fa fa-server"></i> Database</label>
        <select id="node-input-database" style="width: 70%;">
            <option value="master">Loading databases...</option>
        </select>
        <div style="font-size: 11px; color: #666; margin-top: 4px;">
            <i class="fa fa-info-circle"></i> Optional: Defaults to master. Use <code>msg.database</code> to override.
        </div>
    </div>
    
    <div class="form-row">
        <label for="node-input-collection"><i class="fa fa-database"></i> Collection</label>
        <select id="node-input-collection" style="width: 70%;">
            <option value="">Select collection...</option>
        </select>
        <div style="font-size: 11px; color: #666; margin-top: 4px;">
            <i class="fa fa-info-circle"></i> Required unless provided via <code>msg.collection</code>.
        </div>
    </div>

    <!-- Dynamic Match Fields Selector -->
    <div class="form-row" id="matchFields-section" style="display:none;">
        <label><i class="fa fa-key"></i> Match Fields</label>
        <div style="margin-left: 105px; border: 1px solid #ccc; padding: 10px; border-radius: 3px; background-color: #f9f9f9; max-width: 500px;">
            <div id="field-checkboxes" style="max-height: 120px; overflow-y: auto; line-height: 1.4;">
                <!-- Dynamically populated field checkboxes -->
            </div>
            <div style="margin-top: 8px; font-size: 11px; color: #666;">
                <i class="fa fa-info-circle"></i> Select one or more fields to match existing records. Records with matching values in ALL selected fields will be updated. Use <code>msg.matchFields</code> array to override.
            </div>
        </div>
    </div>

    <!-- Operation Mode with Visual Icons -->
    <div class="form-row" id="operation-mode-section" style="display:none;">
        <label><i class="fa fa-cogs"></i> Operation</label>
        <div style="margin-left: 105px; width: calc(100% - 105px); max-width: 500px;">
                <style>
                    /* Override Node-RED's default input width for radio buttons */
                    #operation-mode-section input[type="radio"] {
                        width: auto !important;
                        margin-right: 8px !important;
                    }
                    #operation-mode-section .upsert-mode-option {
                        width: auto !important;
                        display: flex !important;
                        margin-bottom: 0 !important;
                    }
                    .upsert-mode-option:hover {
                        background: #f0f0f0 !important;
                        border-color: #bbb !important;
                        transform: translateY(-1px);
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    .upsert-mode-option:has(input:checked) {
                        background: #e8f5e8 !important;
                        border-color: #4CAF50 !important;
                        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
                    }
                    .upsert-mode-option:has(input[value="updateOnly"]:checked) {
                        background: #e3f2fd !important;
                        border-color: #2196F3 !important;
                        box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
                    }
                    .upsert-mode-option:has(input[value="insertOnly"]:checked) {
                        background: #fff3e0 !important;
                        border-color: #FF9800 !important;
                        box-shadow: 0 2px 8px rgba(255, 152, 0, 0.2);
                    }
                </style>
            <div style="display: flex; flex-direction: column; gap: 15px; padding: 10px 0;">
                <label class="upsert-mode-option" style="display: flex; align-items: flex-start; cursor: pointer; padding: 10px 15px; border: 1px solid #ddd; border-radius: 6px; background: #f9f9f9; transition: all 0.2s ease;">
                    <input type="radio" name="node-input-mode" value="upsert" checked style="margin-right: 15px; margin-top: 3px; transform: scale(1.1);">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; margin-bottom: 6px;">
                            <i class="fa fa-refresh" style="color: #4CAF50; margin-right: 10px; width: 18px; font-size: 16px;"></i>
                            <strong style="font-size: 15px; color: #333;">Upsert</strong>
                        </div>
                        <div style="color: #666; font-size: 13px; line-height: 1.5;">
                            Insert new records or update existing ones based on match criteria
                        </div>
                    </div>
                </label>
                <label class="upsert-mode-option" style="display: flex; align-items: flex-start; cursor: pointer; padding: 10px 15px; border: 1px solid #ddd; border-radius: 6px; background: #f9f9f9; transition: all 0.2s ease;">
                    <input type="radio" name="node-input-mode" value="updateOnly" style="margin-right: 15px; margin-top: 3px; transform: scale(1.1);">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; margin-bottom: 6px;">
                            <i class="fa fa-edit" style="color: #2196F3; margin-right: 10px; width: 18px; font-size: 16px;"></i>
                            <strong style="font-size: 15px; color: #333;">Update Only</strong>
                        </div>
                        <div style="color: #666; font-size: 13px; line-height: 1.5;">
                            Only update existing records, skip insertion of new records
                        </div>
                    </div>
                </label>
                <label class="upsert-mode-option" style="display: flex; align-items: flex-start; cursor: pointer; padding: 10px 15px; border: 1px solid #ddd; border-radius: 6px; background: #f9f9f9; transition: all 0.2s ease;">
                    <input type="radio" name="node-input-mode" value="insertOnly" style="margin-right: 15px; margin-top: 3px; transform: scale(1.1);">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; margin-bottom: 6px;">
                            <i class="fa fa-plus" style="color: #FF9800; margin-right: 10px; width: 18px; font-size: 16px;"></i>
                            <strong style="font-size: 15px; color: #333;">Insert Only</strong>
                        </div>
                        <div style="color: #666; font-size: 13px; line-height: 1.5;">
                            Only insert new records, skip updates of existing records
                        </div>
                    </div>
                </label>
            </div>
            <div style="font-size: 11px; color: #666; margin-top: 8px;">
                <i class="fa fa-info-circle"></i> Operation mode. Use <code>msg.mode</code> to override (upsert, updateOnly, insertOnly).
            </div>
        </div>
    </div>

    <!-- Match Preview -->
    <div class="form-row" id="match-preview-section" style="display:none;">
        <label><i class="fa fa-eye"></i> SQL Preview</label>
        <div style="margin-left: 105px;">
            <div id="match-preview" style="background: #f5f5f5; padding: 8px; border-radius: 3px; font-family: monospace; font-size: 11px; border: 1px solid #ddd;">
                <!-- Shows SQL preview based on selections -->
            </div>
        </div>
    </div>

    <!-- Static Data for Testing -->
    <div class="form-row">
        <label for="node-input-data"><i class="fa fa-code"></i> Test Data</label>
        <div style="position: relative;">
            <textarea id="node-input-data" rows="4" style="width: 100%; font-family: monospace;" 
                      placeholder='{"email": "user@example.com", "name": "John Doe", "role": "admin"}'></textarea>
            <div style="font-size: 11px; color: #666; margin-top: 4px;">
                <i class="fa fa-info-circle"></i> Optional JSON data for testing. msg.payload will override this.
            </div>
        </div>
    </div>
</script>
<script type="text/html" data-help-name="upsert">
    <p>Insert or update records in a Panel collection based on matching field values.</p>
    
    <h3>Configuration</h3>
    <dl class="message-properties">
        <dt>Collection</dt>
        <dd>Select the target collection from the dropdown</dd>
        <dt>Match Fields</dt>
        <dd>Select one or more fields to use for matching existing records. Records with matching values in ALL selected fields will be updated, otherwise a new record will be inserted.</dd>
        <dt>Operation Mode</dt>
        <dd>
            <ul>
                <li><strong>Upsert</strong>: Insert new records or update existing ones (default)</li>
                <li><strong>Update Only</strong>: Only update existing records, skip insertion</li>
                <li><strong>Insert Only</strong>: Only insert new records, skip updates</li>
            </ul>
        </dd>
    </dl>
    
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object</span></dt>
        <dd>The data to upsert</dd>
        <dt class="optional">database <span class="property-type">string</span></dt>
        <dd>Override the configured database (when "Use msg properties" is enabled)</dd>
        <dt class="optional">collection <span class="property-type">string</span></dt>
        <dd>Override the configured collection (when "Use msg properties" is enabled)</dd>
        <dt class="optional">matchFields <span class="property-type">array</span></dt>
        <dd>Override the configured match fields (when "Use msg properties" is enabled)</dd>
        <dt class="optional">mode <span class="property-type">string</span></dt>
        <dd>Override the operation mode: "upsert", "updateOnly", or "insertOnly"</dd>
    </dl>
    
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object</span></dt>
        <dd>The upserted record (including any auto-generated fields)</dd>
        <dt>operation <span class="property-type">string</span></dt>
        <dd>Either "insert" or "update" indicating what operation was performed</dd>
        <dt>recordId <span class="property-type">number</span></dt>
        <dd>The ID of the upserted record</dd>
        <dt>changes <span class="property-type">number</span></dt>
        <dd>Number of rows affected (typically 1)</dd>
    </dl>
    
    <h3>Details</h3>
    <p>This node uses SQLite's native <code>ON CONFLICT</code> clause for efficient upsert operations. It automatically creates unique indexes for the match fields if they don't already exist.</p>
    
    <p>The match fields determine uniqueness - if a record exists with the same values in ALL match fields, it will be updated. Otherwise, a new record is inserted.</p>
    
    <h3>Examples</h3>
    <p><strong>Simple email-based upsert:</strong></p>
    <pre>msg.payload = {
    "email": "user@example.com",
    "name": "John Doe",
    "role": "admin"
};
// Match on: email</pre>
    
    <p><strong>Composite key upsert:</strong></p>
    <pre>msg.payload = {
    "sku": "PROD-123",
    "vendor_id": 5,
    "name": "Product Name",
    "price": 29.99
};
// Match on: sku, vendor_id</pre>
</script>

<!-- Panel Event Listener Node -->
<script type="text/javascript">
    RED.nodes.registerType('listen', {
        category: 'Panel',
        color: '#ffcccb',
        defaults: {
            name: { value: "" },
            database: { value: "master", required: false },
            collection: { value: "", required: false },
            eventTypes: { value: ["INSERT", "UPDATE", "DELETE"] },
            pollingInterval: { value: 10 },
            batchSize: { value: 10 },
            autoAcknowledge: { value: true }
        },
        inputs: 0,
        outputs: 1,
        icon: "node-red-panel.svg",
        label: function() {
            return this.name || "listen";
        },
        oneditprepare: function() {
            const node = this;
            
            // Panel internal token for authentication
            let panelInternalToken = null;
            
            // Load internal token
            function loadInternalToken() {
                return $.getJSON('/panel/internal-token')
                    .done(function(response) {
                        panelInternalToken = response.token;
                    })
                    .fail(function() {
                        console.warn('Could not load panel internal token');
                    });
            }
            
            // Load databases for dropdown
            function loadDatabases() {
                const headers = panelInternalToken ? { 'X-Internal-Token': panelInternalToken } : {};
                $.ajax({
                    url: '/panel/node-databases',
                    type: 'GET',
                    headers: headers
                })
                    .done(function(databases) {
                        const select = $("#node-input-database");
                        select.empty();
                        databases.forEach(function(db) {
                            const selected = db.id === node.database ? 'selected' : '';
                            select.append(`<option value="${db.id}" ${selected}>${db.name}</option>`);
                        });
                        if (node.database) {
                            select.val(node.database);
                        }
                        // Load collections after database is set
                        loadEventCollections();
                    })
                    .fail(function() {
                        console.warn('Could not load databases for dropdown');
                    });
            }
            
            // Load event-enabled collections for dropdown
            function loadEventCollections() {
                const database = $("#node-input-database").val() || 'master';
                const headers = panelInternalToken ? { 'X-Internal-Token': panelInternalToken } : {};
                $.ajax({
                    url: `/panel/event-collections?database=${database}`,
                    type: 'GET',
                    headers: headers
                })
                    .done(function(collections) {
                        const select = $("#node-input-collection");
                        select.empty();
                        select.append('<option value="">Select collection...</option>');
                        collections.forEach(function(collection) {
                            select.append(`<option value="${collection}">${collection}</option>`);
                        });
                        if (node.collection) {
                            select.val(node.collection);
                        }
                    })
                    .fail(function() {
                        console.warn('Could not load event-enabled collections for dropdown');
                        $("#node-input-collection").append('<option value="">No event-enabled collections found</option>');
                    });
            }
            
            // Handle database selection change
            $("#node-input-database").change(function() {
                loadEventCollections();
            });
            
            // Load internal token first, then databases and collections
            loadInternalToken().always(function() {
                loadDatabases();
            });
            
            // Initialize event type checkboxes
            const eventTypes = node.eventTypes || ["INSERT", "UPDATE", "DELETE"];
            ["INSERT", "UPDATE", "DELETE"].forEach(function(eventType) {
                $("#node-input-eventType-" + eventType).prop('checked', eventTypes.includes(eventType));
            });
            
            // Update eventTypes array when checkboxes change
            function updateEventTypes() {
                const selectedTypes = [];
                ["INSERT", "UPDATE", "DELETE"].forEach(function(eventType) {
                    if ($("#node-input-eventType-" + eventType).prop('checked')) {
                        selectedTypes.push(eventType);
                    }
                });
                node.eventTypes = selectedTypes;
            }
            
            $("#node-input-eventType-INSERT, #node-input-eventType-UPDATE, #node-input-eventType-DELETE").change(updateEventTypes);
            
            // Initialize sliders with display updates
            $("#node-input-pollingInterval").val(node.pollingInterval || 10);
            $("#polling-interval-display").text(node.pollingInterval || 10);
            $("#node-input-pollingInterval").on('input', function() {
                $("#polling-interval-display").text($(this).val());
            });
            
            $("#node-input-batchSize").val(node.batchSize || 10);
            $("#batch-size-display").text(node.batchSize || 10);
            $("#node-input-batchSize").on('input', function() {
                $("#batch-size-display").text($(this).val());
            });
            
            $("#node-input-autoAcknowledge").prop('checked', node.autoAcknowledge !== false);
        },
        oneditsave: function() {
            // Save event types
            const selectedTypes = [];
            ["INSERT", "UPDATE", "DELETE"].forEach(function(eventType) {
                if ($("#node-input-eventType-" + eventType).prop('checked')) {
                    selectedTypes.push(eventType);
                }
            });
            this.eventTypes = selectedTypes;
        }
    });
</script>

<script type="text/html" data-template-name="listen">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    
    <div class="form-row">
        <label for="node-input-database"><i class="fa fa-server"></i> Database</label>
        <select id="node-input-database" style="width:70%;">
            <option value="master">Loading databases...</option>
        </select>
    </div>
    
    <div class="form-row">
        <label for="node-input-collection"><i class="fa fa-database"></i> Collection</label>
        <select id="node-input-collection" style="width:70%;">
            <option value="">Loading event-enabled collections...</option>
        </select>
    </div>
    
    <div class="form-row">
        <label><i class="fa fa-bell"></i> Event Types</label>
        <div style="margin-left: 110px;">
            <label style="display: inline-block; margin-right: 15px;">
                <input type="checkbox" id="node-input-eventType-INSERT" style="margin-right: 5px;">
                INSERT
            </label>
            <label style="display: inline-block; margin-right: 15px;">
                <input type="checkbox" id="node-input-eventType-UPDATE" style="margin-right: 5px;">
                UPDATE
            </label>
            <label style="display: inline-block;">
                <input type="checkbox" id="node-input-eventType-DELETE" style="margin-right: 5px;">
                DELETE
            </label>
        </div>
    </div>
    
    <div class="form-row">
        <label for="node-input-pollingInterval"><i class="fa fa-clock-o"></i> Polling Interval (seconds)</label>
        <input type="range" id="node-input-pollingInterval" min="5" max="60" step="5" style="width: 200px;">
        <span id="polling-interval-display">10</span>
    </div>
    
    <div class="form-row">
        <label for="node-input-batchSize"><i class="fa fa-list"></i> Batch Size</label>
        <input type="range" id="node-input-batchSize" min="1" max="50" step="1" style="width: 200px;">
        <span id="batch-size-display">10</span>
    </div>
    
    <div class="form-row">
        <label for="node-input-autoAcknowledge"><i class="fa fa-check"></i> Auto-acknowledge</label>
        <input type="checkbox" id="node-input-autoAcknowledge" style="display:inline-block; width:20px; vertical-align:baseline;">
        <span style="margin-left:10px;">Automatically mark events as processed</span>
    </div>
    
    <div class="form-tips">
        <p><strong>Note:</strong> Only collections with events enabled will appear in the dropdown.</p>
    </div>
</script>

<script type="text/html" data-help-name="listen">
    <p>Listen for database events from Panel collections with events enabled.</p>
    <h3>Configuration</h3>
    <ul>
        <li><strong>Collection</strong>: Select from collections that have events enabled</li>
        <li><strong>Event Types</strong>: Choose which events to listen for (INSERT, UPDATE, DELETE)</li>
        <li><strong>Polling Interval</strong>: How often to check for new events (5-60 seconds)</li>
        <li><strong>Batch Size</strong>: Maximum number of events to process at once (1-50)</li>
        <li><strong>Auto-acknowledge</strong>: Automatically mark events as processed</li>
    </ul>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object</span></dt>
        <dd>Event data with eventType, collection, recordId, oldData, newData, timestamp</dd>
        <dt>topic <span class="property-type">string</span></dt>
        <dd>Event topic in format "panel/events/collection_name"</dd>
    </dl>
</script>